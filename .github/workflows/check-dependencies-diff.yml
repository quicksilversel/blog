name: Detect if dependencies have changed

on:
  workflow_dispatch:

jobs:
  check-diff:
    runs-on: ubuntu-latest
    outputs:
      changes_detected: ${{ steps.diff-check.outputs.changes_detected }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      # ref. https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows
      - name: Cache node modules
        id: cache-npm
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules
        with:
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-

      - name: Clean Install dependencies
        run: npm ci

      - name: Install Madge
        run: npm install -g madge

      - name: Generate dependency tree for my-component
        run: madge --json src/components/UI/About/ > dependencies.json

      - name: List all dependencies
        id: list-dependencies
        run: |
          echo "Files dependent on my-component:"
          cat dependencies.json

      - name: Check for changes in my-component and its dependencies
        id: diff-check
        run: |
          git fetch origin main --depth=2
          DEPENDENCIES=$(jq -r '.[].files[]' dependencies.json)
          DIFF=$(git diff HEAD~1 --name-only $DEPENDENCIES)
          if [ -z "$DIFF" ]; then
            echo "No changes detected in my-component or its dependencies."
            echo "changes_detected=false" >> $GITHUB_ENV
          else
            echo "Changes detected in my-component or its dependencies."
            echo "changes_detected=true" >> $GITHUB_ENV
        shell: bash
