---
title: 'Lessons Learned from Datadog Query Mistakes'
description: 'Refined Datadog queries for ALB metrics, latency, unit handling, and rate computations—mistakes learned and correct patterns.'
topics: ['datadog']
published: true
date: '2025-07-30'
---

## Introduction

Datadog is a powerful tool for monitoring AWS resources, but it can be tricky to get the queries right. Here are some lessons learned from common mistakes when querying AWS Application Load Balancer (ALB) metrics in Datadog.

## 1. httpcode_elb_5xx vs httpcode_target_5xx

- `HTTPCode_ELB_5XX` captures 5xx errors generated by the load balancer (e.g., no healthy targets, timeouts) ([datadoghq.com](https://www.datadoghq.com/blog/key-aws-elb-monitoring-metrics/))
- `HTTPCode_Target_5XX` captures backend (instance/pod) errors returned after forwarding.

If application health is monitored separately, only alert on `httpcode_elb_5xx`. no need to include backend errors twice!

❌ Bad example

```hcl
sum:aws.applicationelb.httpcode_target_5xx{...}.as_rate()
```

✅ Good example

```hcl
sum:aws.applicationelb.httpcode_elb_5xx{...}.as_rate()
```

## 2. min() can't be used with count()

❌ Bad example

```hcl
min(last_5m):sum:trace.servlet.request.errors{...} by {resource_name}.as_count() / sum:trace.servlet.request.hits{...} by {resource_name}.as_count() * 100 > ${each.value.request_errors_threshold
```

Terraform creation passed, but Datadog query UI showed `sum(...)`—min didn’t apply, and error rate always showed 100%. The `min()` vs `sum()` mismatch happens because DataDog sum aggregation overrides the min. The fix was:

✅ Good example

```hcl
min(last_5m):sum:trace.servlet.request.errors{...} by {resource_name}.as_rate() / sum:trace.servlet.request.hits{...} by {resource_name}.as_rate() * 100 > ${each.value.request_errors_threshold
```

Use `.as_rate()` instead of `min()` or `sum()` to properly calculate rate ratios without metric misinterpretation.

## 3. Use avg(), not sum(), for latency metrics

❌ Bad example

```hcl
sum:aws.applicationelb.target_response_time.p95{...}
```

✅ Good example

```hcl
avg:aws.applicationelb.target_response_time.p95{...}
```

Using `sum` across multiple instances aggregated raw latency values and skewed numbers. `avg` produces a sensible p95 across requests; much more readable per-request latency. ([docs.datadoghq.com](https://docs.datadoghq.com/fr/integrations/amazon_elb/))

## 4. Explicitly set units with number_format

If multiple requests or series in a widget, Datadog may drop unit inference—leading to blank or confusing units. This is especially true when mixing queries.

Use Terraform's `number_format` in formula blocks to force units:

```hcl
formula {
  formula_expression = "default_zero(query1)"
  number_format {
    unit {
      canonical {
        unit_name     = "hit"
        per_unit_name = "second"
      }
    }
  }
}
```

This ensures consistent unit display in dashboards. Feature available since Terraform provider v3.56.0. ([github.com](https://github.com/DataDog/terraform-provider-datadog/issues/2142))

## 5. 4xx and 5xx errors are included in "hits"

Querying `sum:trace.servlet.request.hits{...}.as_rate()` includes both successful and error requests:

If 100 hits, 10 of which returned 500, the value is still 100. So using this for error rate numerator/denominator is fine—but avoid summing separate 4xx/5xx when counting total hits. The clean way:

❌ Bad example

```hcl
alb_total_request_rate = "(sum:aws.applicationelb.request_count{...}.as_rate() + sum:aws.applicationelb.httpcode_elb_3xx{...}.as_rate() + sum:aws.applicationelb.httpcode_elb_4xx{...}.as_rate() + sum:aws.applicationelb.httpcode_elb_5xx{...}.as_rate())"
```

✅ Good example

```hcl
alb_total_request_rate = "sum:aws.applicationelb.request_count{...}.as_rate()"
```

Avoid redundant sums over error code categories.

## Final takeaways

- Use `httpcode_elb_5xx` to monitor load balancer health; leave target errors to backend monitors.
- Never mix `min()` with `sum()` in Datadog queries—use `.as_rate()`.
- Monitor latency with `avg()` to avoid skew.
- Always define units explicitly when mixing query series.
- Be mindful of how Datadog aggregates error counts in “hits.”

Refer to AWS‑ELB metrics documentation for deeper context and definitions. ([docs.datadoghq.com](https://docs.datadoghq.com/fr/integrations/amazon_elb/))

Done.
